generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String               @id @default(uuid())
  authId               String?              @unique
  name                 String
  email                String               @unique
  phone                String?
  address              String?
  postalCode           String?
  city                 String?
  hasTenantCertificate Boolean              @default(false)
  role                 UserRole             @default(TENANT)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  fikenCompanySlug     String?
  fikenApiToken        String?
  standardRentPerSqm   Int                  @default(185)
  interests            Interest[]
  leaseContracts       LeaseContract[]
  MaintenanceRequest   MaintenanceRequest[]
  messages             Message[]
  properties           Property[]           @relation("OwnerProperties")
  issuedCertificates   TenantCertificate[]  @relation("IssuedCertificates")
  receivedCertificates TenantCertificate[]  @relation("ReceivedCertificates")
  tenantWarnings       TenantWarning[]
  contributions        TenantContribution[]
  projectAuditLogs     ProjectAuditLog[]
}

model TenantCertificate {
  id            String   @id @default(uuid())
  tenantId      String
  issuerId      String
  totalScore    Int
  behaviorScore Int
  noiseScore    Int
  paymentScore  Int
  cleaningScore Int
  stars         Int      @default(0)
  comment       String?
  pdfUrl        String?
  pdfHash       String?
  createdAt     DateTime @default(now())
  issuer        User     @relation("IssuedCertificates", fields: [issuerId], references: [id])
  tenant        User     @relation("ReceivedCertificates", fields: [tenantId], references: [id])
}

model Property {
  id             String         @id @default(uuid())
  name           String
  address        String
  gnr            String?
  bnr            String?
  ownerId        String
  status         PropertyStatus @default(ACTIVE)
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  imageUrl       String?
  parentId       String?
  snr            String?
  owner          User           @relation("OwnerProperties", fields: [ownerId], references: [id])
  Property       Property?      @relation("PropertyToProperty", fields: [parentId], references: [id])
  other_Property Property[]     @relation("PropertyToProperty")
  units          Unit[]
  projects       Project[]
}

model Unit {
  id                 String               @id @default(uuid())
  propertyId         String
  name               String
  sizeSqm            Float
  rentAmount         Float
  depositAmount      Float
  status             UnitStatus           @default(AVAILABLE)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  imageUrl           String?
  roomCount          Int
  notes              String?
  unitNumber         String?
  interests          Interest[]
  leaseContracts     LeaseContract[]
  MaintenanceRequest MaintenanceRequest[]
  roomDetails        Room[]
  TenantWarning      TenantWarning[]
  viewings           Viewing[]
  property           Property             @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unitImages         UnitImage[]
  contributions      TenantContribution[]
  projects           Project[]
}

model Viewing {
  id        String   @id @default(uuid())
  unitId    String
  date      DateTime
  notes     String?
  checklist Json?    // Stores the state of checklist items
  confirmed Boolean  @default(false)
  createdAt DateTime @default(now())
  unit      Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
}

model TenantContribution {
  id          String             @id @default(uuid())
  type        ContributionType
  description String
  imageUrl    String?
  status             ContributionStatus @default(PENDING)
  starsAwarded       Int                @default(0)
  createdAt          DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  tenantId    String
  unitId      String

  tenant User @relation(fields: [tenantId], references: [id])
  unit   Unit @relation(fields: [unitId], references: [id])
}

enum ContributionType {
  IMPROVEMENT_UNIT
  IMPROVEMENT_PROPERTY
  OWN_INITIATIVE
}

enum ContributionStatus {
  PENDING
  REVIEWED
  COMPLETED
}

model UnitImage {
  id          String   @id @default(uuid())
  unitId      String
  url         String
  description String?
  createdAt   DateTime @default(now())
  unit        Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
}

model Room {
  id           String      @id @default(cuid())
  unitId       String
  name         String
  type         RoomType    @default(OTHER)
  sizeSqm      Float?
  description  String?
  scanUrl      String?
  scanFormat   String?
  scanStatus   String      @default("PENDING")
  thumbnailUrl String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  unit         Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  images       RoomImage[]
}

model RoomImage {
  id        String   @id @default(cuid())
  roomId    String
  url       String
  createdAt DateTime @default(now())
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
}

model LeaseContract {
  id                 String               @id @default(uuid())
  unitId             String
  tenantId           String
  startDate          DateTime
  endDate            DateTime?
  rentAmount         Float
  depositAmount      Float
  status             ContractStatus       @default(DRAFT)
  signedAt           DateTime?
  signedIp           String?
  pdfUrl             String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  fikenCustomerId    String?
  fikenInvoiceId     String?
  InspectionProtocol InspectionProtocol[]
  tenant             User                 @relation(fields: [tenantId], references: [id])
  unit               Unit                 @relation(fields: [unitId], references: [id], onDelete: Cascade)
  MessageThread      MessageThread?
}

model MaintenanceRequest {
  id          String            @id @default(uuid())
  unitId      String
  tenantId    String
  title       String
  description String
  status      MaintenanceStatus @default(REPORTED)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  User        User              @relation(fields: [tenantId], references: [id])
  Unit        Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)
}

model Message {
  id            String        @id @default(uuid())
  threadId      String
  senderId      String
  content       String
  timestamp     DateTime      @default(now())
  sender        User          @relation(fields: [senderId], references: [id])
  MessageThread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

model Interest {
  id        String         @id @default(uuid())
  unitId    String
  userId    String?
  name      String
  email     String
  phone     String?
  message   String?
  status    InterestStatus @default(PENDING)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  unit      Unit           @relation(fields: [unitId], references: [id], onDelete: Cascade)
  user      User?          @relation(fields: [userId], references: [id])
}

model TenantWarning {
  id       String   @id @default(uuid())
  tenantId String
  unitId   String?
  type     String
  message  String
  sentAt   DateTime @default(now())
  User     User     @relation(fields: [tenantId], references: [id])
  Unit     Unit?    @relation(fields: [unitId], references: [id])
}

model InspectionCheckpoint {
  id                 String             @id @default(uuid())
  protocolId         String
  roomName           String // Changed from room (enum or string reference)
  element            String // e.g., "Wall", "Floor", "Window"
  status             String // "OK", "NOT_OK", "FIXED"
  notes              String?
  images             CheckpointImage[]
  InspectionProtocol InspectionProtocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)
}

model CheckpointImage {
  id           String               @id @default(uuid())
  checkpointId String
  url          String
  createdAt    DateTime             @default(now())
  checkpoint   InspectionCheckpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade)
}

model InspectionProtocol {
  id                      String                 @id @default(uuid())
  contractId              String
  type                    InspectionType
  date                    DateTime               @default(now())
  electricityMeterReading String?
  keysHandedOver          Int?
  notes                   String?
  audioUrl                String?
  transcription           String?
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt
  signedByTenant          Boolean                @default(false)
  signedByOwner           Boolean                @default(false)
  signedAt                DateTime?
  checkpoints             InspectionCheckpoint[]
  LeaseContract           LeaseContract          @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model MessageThread {
  id            String        @id
  contractId    String        @unique
  createdAt     DateTime      @default(now())
  Message       Message[]
  LeaseContract LeaseContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model DevNote {
  id         String   @id @default(cuid())
  content    String
  author     String?
  isResolved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  imageUrl   String?
}

enum UserRole {
  OWNER
  ADMIN
  MANAGER
  TENANT
}

enum PropertyStatus {
  ACTIVE
  SOLD
  INACTIVE
}

enum UnitStatus {
  AVAILABLE
  RESERVED
  RENTED
  SOLD
}

enum ContractStatus {
  DRAFT
  SENT
  SIGNED
  TERMINATED
}

enum MaintenanceStatus {
  REPORTED
  IN_PROGRESS
  COMPLETED
}

enum InspectionType {
  MOVE_IN
  MOVE_OUT
}

enum RoomType {
  LIVING_ROOM
  KITCHEN
  BEDROOM
  BATHROOM
  HALLWAY
  STORAGE
  BALCONY
  GARAGE
  OTHER
}

enum InterestStatus {
  PENDING
  CONTACTED
  REJECTED
  OFFERED
}

model Project {
  id          String   @id @default(uuid())
  title       String
  description String?  
  status      String   @default("ACTIVE") // ACTIVE, ARCHIVED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  propertyId  String?
  property    Property? @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  customPropertyName String? // For projects without a property (Tilfeldig prosjekt)

  unitId      String?
  unit        Unit?    @relation(fields: [unitId], references: [id], onDelete: Cascade)

  entries     ProjectEntry[]
  tasks       ProjectTask[]
  reports     ProjectReport[]
  locationTasks LocationTask[]
  auditLogs   ProjectAuditLog[]
}

model ProjectAuditLog {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String   // DELETE, EDIT, CREATE
  entityType String  // NOTE, IMAGE, TASK
  entityId  String?  // ID of the deleted/edited item (optional if deleted)
  details   String?  // "Deleted image of wall"
  createdAt DateTime @default(now())
}

model ProjectEntry {
  id              String   @id @default(uuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  type            String   // NOTE, IMAGE, MEASUREMENT
  content         String?  
  imageUrl        String?
  includeInReport Boolean  @default(false)
  rotation        Int      @default(0)
  createdAt       DateTime @default(now())
}

model ProjectTask {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task      String
  done      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ProjectReport {
  id        String   @id @default(uuid())
  projectId String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  pdfUrl    String
  pdfHash   String?
  createdAt DateTime @default(now())
}

model LocationTask {
  id               String   @id @default(uuid())
  title            String
  description      String?  
  locationName     String
  address          String?
  latitude         Float
  longitude        Float
  radius           Int      @default(150)
  type             String   @default("SIMPLE") // SIMPLE, CHECKLIST
  
  relatedProjectId String?
  project          Project? @relation(fields: [relatedProjectId], references: [id])
  
  items            LocationTaskItem[]
  
  done             Boolean  @default(false)
  createdAt        DateTime @default(now())
}

model LocationTaskItem {
  id             String       @id @default(uuid())
  locationTaskId String
  locationTask   LocationTask @relation(fields: [locationTaskId], references: [id], onDelete: Cascade)
  content        String
  done           Boolean      @default(false)
  createdAt      DateTime     @default(now())
}
